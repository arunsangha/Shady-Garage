{% extends "base.html" %}
{% load staticfiles %}
{% block body %}
  <!--
    //TODO: Hente replyies to comments etter at det er ferdig.
  -->
  <div class="container">
    <div class="activity-container">
    <div class="notification-list-container"></div>
    <a href="#" id="loadMoreNotification" class="btn btn-info">Flere aktiviteter!</a>

    <!-- alert is only visual when there is no more notifications -->
    <div class="">
      <strong>Å nei..!</strong> Bli med på treff da, så skjer det nok noe mer her!
      <a href="{% url 'meets:meets_list' %}" class="btn btn-info"><strong>Trykk på meg! </strong></a>
    </div>

   </div>
  </div>
{% endblock %}

{% block script %}
  <script>
  $(document).ready(function(){
      <!-- globale variabler -->
      var notifList = [];
      var nextUrl;
      <!-- fetch notifications -->
      function fetchNotifications(url){
        var fetchUrl;
        if(url){
          fetchUrl = url;
        }else{
          fetchUrl = '/../../api/posts/accounts/myactivities/'
        }
        $.ajax({
          url: fetchUrl,
          method: 'GET',
          success:function(data){
            notifList = data.results
            nextUrl = data.next
            parseNotifications()
          },
          error:function(data){
            console.log(data)
            console.log("ERROR!->! I henting av notifications")
          }
        })
      };
      fetchNotifications();

      function parseNotifications(){
        if(notifList == 0){
          <!-- add bedre design om ikke noe aktivitet har skjedd -->
          $('.notification-list-container').append(
            "<h5> Godkjent EU-kontroll ;)</h5>"
          );
        }else{
          $.each(notifList, function(key, value){
            var owner = value.owner.username
            var actor = value.user_fk.username
            var actor_image = value.user_fk.profile.thumbnail
            var post_title = value.post_fk.post_title
            var post_url = value.post_fk.url
            var liked = value.liked
            var commented = value.commented
            var timesince = value.timesince

            var mark_seen_text_button = value.did_mark_seen
            var button_mark;
            var comment;
            if(mark_seen_text_button){
              button_mark = "Sett"
            }else{
              button_mark = "Marker sett"
            }

            if(commented){
              comment = value.noti_fk.comment

              $('.notification-list-container').append(
                `
                <div class="media">
                  <img class="mr-3" width="64px" height="64px" src="${actor_image}" alt="">
                  <div class="media-body">
                    <h5 class="mt-0">${actor} kommenterte:</h5>
                      <h3><footer class="blockquote-footer">${comment}</footer></h3>
                      <h6>På din post:<a href="${post_url}">${post_title}</a></h6>
                      <a href="#" id="markSeen" data-id="${value.id}" class="btn btn-warning btn-sm">${button_mark}</a>
                  </div>
                  <p>For ${timesince}</p>
                </div>

                `
              )
            } else if(value.noti_reply_fk){
              $('.notification-list-container').append(
                `
                <div class="media">
                  <img class="mr-3" width="64px" height="64px" src="${actor_image}" alt="">
                  <div class="media-body">
                    <h5 class="mt-0">${value.noti_reply_fk.user_fk.username} svarte:</h5>
                      <h3><footer class="blockquote-footer">${value.noti_reply_fk.comment}</footer></h3>
                      <h6>til din kommentar:<a href="${post_url}">${value.noti_reply_fk.comment_fk.comment}</a></h6>
                      <a href="#" id="markSeen" data-id="${value.id}" class="btn btn-warning btn-sm">${button_mark}</a>
                  </div>
                  <p>For ${value.noti_reply_fk.created}</p>
                </div>

                `
              )
            }else {
              $('.notification-list-container').append(
                `
                <div class="media">
                  <img class="mr-3" width="64px" height="64px" src="${actor_image}" alt="">
                  <div class="media-body">
                    <h5 class="mt-0" id="test" data-id="${value.id}">${actor} likte din post: <a href="${post_url}">${post_title}</a></h5>
                    <a href="#" id="markSeen" data-id="${value.id}" class="btn btn-warning btn-sm"> ${button_mark}</a>
                  </div>
                  <p>For ${timesince}</p>
                </div>

                `
              )
            }

          })

        }
      }

      $("#loadMoreNotification").click(function(event){
          event.preventDefault()
          if(nextUrl){
            fetchNotifications(nextUrl)
          }else{
            $("#loadMoreNotification").html("Ingen flere aktiviteter..")
            $("#alert-empty").show()
          }
      })


      $(document.body).on("click", "#markSeen", function(e){
        e.preventDefault()
        this_ = $(this)
        var notiId = this_.attr("data-id")
        var markSeenUrl = '/../../api/posts/accounts/marknoti_seen/' + notiId + '/'

        $.ajax({
          method:'GET',
          url:markSeenUrl,
          success:function(data){
            if(data.is_seen){
              this_.text("Sett")
            }else{
              this_.text("Sett")
            }
          },
          error:function(data){
            console.log("ERROR!-> Marking sett on notif")
          }
        })
      })
  });

  </script>
{% endblock %}
