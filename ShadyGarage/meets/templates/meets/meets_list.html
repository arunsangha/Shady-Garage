{% extends "base.html" %}
{% load staticfiles %}
{% block title %} Shady Meets {% endblock %}
{% block body %}

{% if user.is_authenticated %}

<style>
  body{
    background-image: url({%static 'images/interior.jpeg'%});
    background-repeat:no-repeat;
    background-attachment: fixed;
  }
</style>

<div class="background_meets_list"></div>
  <div class="meet-search-container">
    <a class="btn btn-info btn-custom" href="{%url 'meets:create_meet'%}" role="button">Opprett treff! </a>
    <form action="{% url 'meets:meets_list'%}" method="action">
      <input type="text" name="q" placeholder="Søk">
      <input type="submit" value="Søk" class="btn btn-sm btn-warning">
    </form>
  </div>

<div id="fraAjax"></div>
<div class="meet-bottom-load-container">
    <a href="#" id="loadMeets" class="btn btn-info">Se flere treff</a>
</div>

{% else %}
<div class="container" >
    <div class="jumbotron">
      <h1>Ops, ser ut som du ikke er logget inn!</h1>
      <p class="lead">Logg inn eller registrer deg for å se treff i nærheten av deg!</p>
      <a class="btn btn-danger btn-lg" href="{% url 'accounts:login'%}" role="button">Logg inn</a>
      <a class="btn btn-info btn-lg" href="{%url 'accounts:signup'%}" role="button">Registrer meg!</a>
    </div>

    <div id ="gif" align="center">
    <iframe src="https://giphy.com/embed/rUwbpQKelwneM" width="100%" height="270" frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a href="https://giphy.com/gifs/day-perfect-burnout-rUwbpQKelwneM"></a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block script %}
  <script>

  function getParameterByName(name, url) {
      if (!url) url = window.location.href;
      name = name.replace(/[\[\]]/g, "\\$&");
      var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return '';
      return decodeURIComponent(results[2].replace(/\+/g, " "));
  }

  $(document).ready(function(){
      console.log("Working")
      var query = getParameterByName('q');
      var nextUrl;
      var meetsList = [];

      function fetchMeets(url){
        var fetchUrl;
        if(!url){
          fetchUrl = "../../api/meets"
        }else{
          fetchUrl = url
        }

        $.ajax({
          url:fetchUrl,
          data:{
            'q':query
          },
          method:"GET",
          success:function(data){
            meetsList = data.results
            nextUrl = data.next
            parseMeets()
          }, error:function(data){
            console.log("ERROR")
          }
        })
      }

      fetchMeets()

      function parseMeets(){
        if(meetsList == 0){
          $("#fraAjax").append(
            "<h2> Fant ingen meets..</h2>"
          )
        } else {
            $.each(meetsList, function(key, value){
              var username = value.user_fk.username
              var meet_name = value.meet_name
              var date = value.date
              var time = value.time
              var description = value.description
              var users_joining = value.users_joining

            $("#fraAjax").append(
                "<div class='meet-list-container'> <div class='meet-card-container'>"
                + "<div class='meet-card-time-container'>"
                      + "<p>" + value.day + "</p>"
                      + "<p>"+ date + "</p>"
                      + "<p>"+ time +"</p> </div>"
                      + "<div class='meet-card-info-container'>"
                      + "<h2><a href='" + value.url + "' class='btn-meet-name'>" + meet_name + "</a></h2>"
                      + "<div class='meet-card-info'>"
                      + "<h4>Ikea furuset</h4>"
                      +  "<h4>Skal:"+  value.users_joining +  "</h4>"
                      +  "</div>"
                      + "</div> </div>"
            )
            })
        }
      }

      $("#loadMeets").click(function(event){
        event.preventDefault()
        if(nextUrl){
          fetchMeets(nextUrl)
        }else{
          $("#loadMeets").html("Ingen flere treff")
        }
      })
  });

  </script>
{% endblock %}
