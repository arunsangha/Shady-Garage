{% extends "base.html" %}
{% load staticfiles %}
{% block title %}Shady: {{post.post_title}} {% endblock %}

{% block body %}

{% include "posts/comment-replys-modal.html" %}
  <div class="post-detail-container">
    <div class="post-detail-username">
      <a href="{% url 'accounts:profile_page_pk' pk=post.user_fk.pk%}"><h2> {{post.user_fk.username}} </h2></a>
    </div>
    <div class="post-container">
        <h2 class="post-detail-post-title" id="sluuug" data-sluug="{{post.slug}}"> {{ post.post_title}} </h2>
        {% if post.post_image %}
        <img src="{{post.post_image.url}}" alt="" class="post-detail-image">
        {% endif %}

        <p class="post-detail-post-comment"> {{ post.post_description}} </p>
        <p> {{post.post_created|timesince}}</p>
          <!--
            //TODO:!LANSERING! Bytte ut u=www.shadygarage.pythonanywhere.com/{{request.get_full_path}}" med  u=www.shadygarage.com/{{request.get_full_path}}
          -->
          <a href="https://www.facebook.com/sharer/sharer.php?u=shadygarage.pythonanywhere.com/{{request.get_full_path}}">
            <input type="image" src="{% static 'images/facebooklogo.png'%}" class="facebookShare" id="facebookSharePost"/>
          </a>
    </div>
    {% if request.user == post.user_fk %}
      <a href="{% url 'posts:post_delete' slug=post.slug %} " class="btn btn-danger">Slett post!</a>
      <a href="{% url 'posts:post_update' slug=post.slug %}" class="btn btn-info">Oppdater post!</a>
    {% endif %}

    <a class="post-detail-comment-button" href="{% url 'posts:post_comment' slug=post.slug%}">Kommenter</a>
    <div class="post-commentcontainer">

    </div>

    </div>


{% endblock %}

{% block script %}
<script>
  $(document).ready(function(){
    var slug = document.getElementById("sluuug").getAttribute("data-sluug");
    var commentsList = [];
    function fetchComments(){
      $.ajax({
        method: "GET",
        url: '/../../../api/posts/comments/' + slug ,
        success:function(data){
          commentsList = data
          parseComments();
        },error:function(data){
          console.log("Error!!-> in getting comments")
        },

      })

    }

    fetchComments()

    function parseComments(){
        $.each(commentsList, function(key, value){
          var username = value.user_fk.username
          var id_ = value.user_fk.id
          if(value.comment_replys > 0){
            $(".post-commentcontainer").append(
              `
              <div class="commentcontainer-comment">
                <div class='commentcontainer-userinfo'>
                  <div class='commentcontainer-userinfo-profilepiccontainer'>
                    <img class='commentcontainer-userinfo-profilepic' src="" alt="bilde">
                  </div>
                  <div class="commentcontainer-userinfo-textinfo">
                    <p>Bruker: <a href="#">${value.user_fk.username}</a></p>
                    <p>Dato: ${value.created}</p>
                    <a href="#" id="answerComment" class="btn btn-warning btn-sm" data-slug="${value.slug}" data-id="${value.id}">Svar</a>
                    <a href="#" id="commentReplyButton" data-comment-user="${value.user_fk.username}" data-id="${value.id}" class="btn btn-danger btn-sm"> Se svar <span class="badge badge-light">${value.comment_replys}</span></a>
                </div>
                </div>
                <div class="commentcontainer-commentfield">
                  <p>${value.comment}</p>
                </div>
               </div>
              `
            )
          }else{
            $(".post-commentcontainer").append(
              `
              <div class="commentcontainer-comment">
                <div class='commentcontainer-userinfo'>
                  <div class='commentcontainer-userinfo-profilepiccontainer'>
                    <img class='commentcontainer-userinfo-profilepic' src="" alt="bilde">
                  </div>
                  <div class="commentcontainer-userinfo-textinfo">
                    <p>Bruker: <a href="#">${value.user_fk.username}</a></p>
                    <p>Dato: ${value.created}</p>
                    <a href="#" id="answerComment" class="btn btn-warning btn-sm" data-slug="${value.slug}" data-id="${value.id}">Svar</a>
                </div>
                </div>
                <div class="commentcontainer-commentfield">
                  <p>${value.comment}</p>
                </div>
               </div>
              `
            )
          }
        })
    }


    $(document.body).on("click", "#commentReplyButton", function(e){
      e.preventDefault()
      var this_ = $(this)
      var id_ = this_.attr("data-id")
      var replys = [];
      $.ajax({
        method:'GET',
        url: '../../../api/posts/comment_replys/' + id_,
        success:function(data){
          replys = data.results
        },error:function(data){
          console.log("ERROR!!-> Getting comment replys")
        }
      })

      $("#exampleModalCenter").modal({})
      $("#exampleModalTitle").text("Svar til " + this_.attr("data-comment-user") + " sin kommentar")
      $("#exampleModalCenter").on("shown.bs.modal", function(){
        $(".replys-container").html()
         $.each(replys, function(key, value){
           var clone_ = $(".replys-container").clone()
           clone_.find("p")[0].text("HEI")


         })
      })

    });

    $(document).ready(function(){
      $("#exampleModalCenter").on("hidden.bs.modal", function(e){
           $('.modal-body').html()
      })
    })


  });
</script>

{% endblock %}
