{% extends "base.html" %}
{% load staticfiles %}
{% block title %}ShadyGarage{% endblock %}
{% block body %}
{% if user.is_authenticated %}
  <div class="container" align="center">
    <form action="{% url 'posts:posts_feed' %}" method="action">
      <input type="text" name="q" placeholder="Søk">
      <input type="submit" name="" class="btn btn-info" value="Søk">
    </form>
    <a href="{% url 'posts:post_create'%}" class="btn btn-info">Del en post!</a>
    <div id="fraAjax"> </div>
    <a href="#" id="loadMore" class="btn btn-info">Fler posts</a>
  </div>
{% else %}
<div class="container" >
  <div class="jumbotron">
    <h1>Ops, ser ut som du ikke er logget inn!</h1>
    <p class="lead">Logg inn eller registrer deg for å se treff i nærheten av deg!</p>
    <a class="btn btn-danger btn-lg" href="{% url 'accounts:login'%}" role="button">Logg inn</a>
    <a class="btn btn-info btn-lg" href="{%url 'accounts:signup'%}" role="button">Registrer meg!</a>
  </div>

  <div id ="gif" align="center">
    <iframe src="https://giphy.com/embed/rUwbpQKelwneM" width="100%" height="270" frameBorder="0" class="giphy-embed" allowFullScreen></iframe><p><a href="https://giphy.com/gifs/day-perfect-burnout-rUwbpQKelwneM"></a>
  </div>
</div>
{% endif %}
{% endblock %}
{% block script %}
<script>
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    $(document).ready(function(){
      console.log("working");
      var query = getParameterByName('q')
      var nextUrl;
      var postList = [];

      function parsePosts(){
        if(postList == 0){
          $("#fraAjax").append(
            "<h5>Fant ikke noe...</h5>"
          )
        }else{
          //Posts exists!
        $.each(postList, function(key, value){
            var user_name = value.user_fk.username
            var post_title = value.post_title
            var post_description = value.post_description
            var post_created = value.post_created
            var timesince = value.timesince
            var likes = value.post_likes
            var verb = 'Like'
            if(value.did_like){
              verb = 'Unlike'
            }

            var image = value.post_image
            var has_image = false
            if (image != null) {
              has_image = true
            }

            if(has_image){
              $("#fraAjax").append(
                  "<div class='card text-center' style='margin:20px;'><div class='card-header'>" +
                      user_name
                    + "</div> <div class='card-body'> <h3 class='card-text'><a href='" + value.url + "'>"
                    + post_title + "</a></h3> <p class='card-text'>" + post_description + "</p>" +
                     "<div class='post-image'><img src='" + image + "' style='width:30%;height:30%;'></div>"+
                     "<a href='#' data-id='" + value.id + "' class='like-button'>" + verb + "</a> ("+ likes + ") | " +
                      "<a href='" + value.comment_url + "' class='comment-button'>Kommenter</a>" +
                    "</div><div class='card-footer text-muted'>"
                    +  timesince
                    + "</div></div>"
              )
            }else{
              $("#fraAjax").append(
                  "<div class='card text-center' style='margin:20px;'><div class='card-header'>" +
                      user_name
                    + "</div> <div class='card-body'> <h3 class='card-text'><a href='" + value.url + "'>"
                    + post_title + "</a></h3> <p class='card-text'>" + post_description + "</p>" +
                     "<div class='post-image'></div>"+
                     "<a href='#' data-id='" + value.id + "' class='like-button'>" + verb + "</a> ("+ likes + ") | " +
                      "<a href='" + value.comment_url + "' class='comment-button'>Kommenter</a>" +
                    "</div><div class='card-footer text-muted'>"
                    +  timesince
                    + "</div></div>"
              )
            }
        })
       }
      }


    function fetchPosts(url){
      var fetchUrl;
      if(!url){
        fetchUrl = "../../api/posts/"
      }else{
        fetchUrl = url
      }
      $.ajax({
        url:fetchUrl,
        data:{
          'q':query
        },
        method:"GET",
        success:function(data){
          postList = data.results
          nextUrl = data.next
          parsePosts()
        },
          error:function(data){
          console.log("Error")
          console.log(data)
        }
      })
    }

      fetchPosts()
      $("#loadMore").click(function(event){
        event.preventDefault()
        if(nextUrl){
          fetchPosts(nextUrl)
        } else{
          $("#loadMore").html("Ingen flere posts")
        }
      })

      $(document.body).on("click", ".like-button", function(e){
          e.preventDefault()
          this_ = $(this)
          var postId = this_.attr("data-id")
          var likedUrl = '../../api/posts/' + postId + '/like/'

          $.ajax({
            method: 'GET',
            url: likedUrl,
            success:function(data){
              if(data.liked){
                this_.text("Liker")
              }else{
                this_.text("Unlike")
              }
            }, error:function(data){
              console.log("Error in likes method!")
            }

          })
      })
    });
  </script>
{% endblock %}
